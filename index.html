import React, { useState, useEffect } from 'react';
import { Activity, Trophy, Timer, Play, Pause, RotateCcw, User, TrendingUp, Award, Star, Plus, X, Palette, Filter, Camera, Target } from 'lucide-react';

const themes = {
  emerald: { gradient: 'from-emerald-50 to-teal-100', button: 'bg-emerald-600', buttonHover: 'hover:bg-emerald-700', text: 'text-emerald-600' },
  purple: { gradient: 'from-purple-50 to-pink-100', button: 'bg-purple-600', buttonHover: 'hover:bg-purple-700', text: 'text-purple-600' },
  blue: { gradient: 'from-blue-50 to-cyan-100', button: 'bg-blue-600', buttonHover: 'hover:bg-blue-700', text: 'text-blue-600' },
  rose: { gradient: 'from-rose-50 to-orange-100', button: 'bg-rose-600', buttonHover: 'hover:bg-rose-700', text: 'text-rose-600' },
  slate: { gradient: 'from-slate-50 to-gray-100', button: 'bg-slate-600', buttonHover: 'hover:bg-slate-700', text: 'text-slate-600' }
};

const disciplines = ['Dressage', 'Show Jumping', 'Cross Country', 'Eventing', 'Trail Riding', 'Western Pleasure', 'Reining', 'Barrel Racing', 'Endurance', 'Hunter', 'Training', 'Lesson', 'Hacking', 'Lunging', 'Other'];

const exercises = ['Flatwork', 'Grids', 'Cavaletti', 'Transitions', 'Lateral Work', 'Circles & Serpentines', 'Lead Changes', 'Collection', 'Extension', 'Free Jumping', 'Trail Obstacles', 'Speed Work'];

export default function App() {
  const [activeTab, setActiveTab] = useState('home');
  const [theme, setTheme] = useState('emerald');
  const [workouts, setWorkouts] = useState([
    { id: 1, name: 'Core Stability', duration: 20, category: 'strength', completed: false },
    { id: 2, name: 'Leg Strengthening', duration: 25, category: 'strength', completed: false },
    { id: 3, name: 'Balance Training', duration: 15, category: 'balance', completed: false },
    { id: 4, name: 'Flexibility Flow', duration: 30, category: 'flexibility', completed: false },
    { id: 5, name: 'Cardio Conditioning', duration: 20, category: 'cardio', completed: false }
  ]);
  const [rides, setRides] = useState([]);
  const [filterHorse, setFilterHorse] = useState('all');
  const [filterDiscipline, setFilterDiscipline] = useState('all');
  const [showModal, setShowModal] = useState(false);
  const [newRide, setNewRide] = useState({
    horseName: '', duration: '', discipline: 'Dressage', rating: 0, exercises: [],
    notes: '', date: new Date().toISOString().split('T')[0], photo: null
  });
  const [timer, setTimer] = useState(0);
  const [isRunning, setIsRunning] = useState(false);
  const [selectedWorkout, setSelectedWorkout] = useState(null);
  const [achievements, setAchievements] = useState([
    { id: 1, name: 'First Stride', description: 'Complete your first workout', goal: 1, unlocked: false, icon: 'ðŸ†' },
    { id: 2, name: 'Hat Trick', description: 'Complete 3 workouts', goal: 3, unlocked: false, icon: 'ðŸŽ¯' },
    { id: 3, name: 'Full Stable', description: 'Complete all 5 workouts', goal: 5, unlocked: false, icon: 'â­' },
    { id: 4, name: 'Time Keeper', description: 'Train for 60 minutes total', goal: 60, type: 'minutes', unlocked: false, icon: 'â°' },
    { id: 5, name: 'Century Rider', description: 'Train for 100 minutes total', goal: 100, type: 'minutes', unlocked: false, icon: 'ðŸ’¯' },
    { id: 6, name: 'Strength Champion', description: 'Complete all strength workouts', goal: 2, type: 'strength', unlocked: false, icon: 'ðŸ’ª' },
    { id: 7, name: 'First Ride', description: 'Log your first ride', goal: 1, type: 'rides', unlocked: false, icon: 'ðŸ´' },
    { id: 8, name: 'Dedicated Rider', description: 'Log 5 rides', goal: 5, type: 'rides', unlocked: false, icon: 'ðŸ‡' },
    { id: 9, name: 'Perfect Score', description: 'Get a 5-star ride', goal: 1, type: '5star', unlocked: false, icon: 'â­' }
  ]);
  const [showAchievement, setShowAchievement] = useState(null);

  useEffect(() => {
    let interval;
    if (isRunning) interval = setInterval(() => setTimer(t => t + 1), 1000);
    return () => clearInterval(interval);
  }, [isRunning]);

  const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;

  const completeWorkout = () => {
    if (selectedWorkout) {
      setWorkouts(workouts.map(w => w.id === selectedWorkout.id ? {...w, completed: true} : w));
      checkAchievements();
      setSelectedWorkout(null);
      setTimer(0);
      setIsRunning(false);
    }
  };

  const handlePhoto = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => setNewRide({...newRide, photo: reader.result});
      reader.readAsDataURL(file);
    }
  };

  const toggleEx = (ex) => {
    const exs = newRide.exercises.includes(ex) ? newRide.exercises.filter(e => e !== ex) : [...newRide.exercises, ex];
    setNewRide({...newRide, exercises: exs});
  };

  const addRide = () => {
    if (newRide.horseName && newRide.duration) {
      const ride = {id: Date.now(), ...newRide, duration: parseInt(newRide.duration)};
      setRides([ride, ...rides]);
      setNewRide({horseName: '', duration: '', discipline: 'Dressage', rating: 0, exercises: [], notes: '', date: new Date().toISOString().split('T')[0], photo: null});
      setShowModal(false);
      checkAchievements(null, rides.length + 1, ride.rating);
    }
  };

  const checkAchievements = (w = null, rc = null, rr = null) => {
    const cc = workouts.filter(x => x.completed).length + (w ? 1 : 0);
    const tm = workouts.filter(x => x.completed).reduce((a,x) => a + x.duration, 0) + (selectedWorkout?.duration || 0);
    const sc = workouts.filter(x => x.category === 'strength' && x.completed).length + (selectedWorkout?.category === 'strength' ? 1 : 0);
    const tr = rc !== null ? rc : rides.length;
    const h5 = rr === 5 || rides.some(r => r.rating === 5);

    setAchievements(prev => prev.map(a => {
      if (a.unlocked) return a;
      let u = false;
      if (!a.type && cc >= a.goal) u = true;
      if (a.type === 'minutes' && tm >= a.goal) u = true;
      if (a.type === 'strength' && sc >= a.goal) u = true;
      if (a.type === 'rides' && tr >= a.goal) u = true;
      if (a.type === '5star' && h5) u = true;
      if (u) {
        setShowAchievement(a);
        setTimeout(() => setShowAchievement(null), 3000);
        return {...a, unlocked: true};
      }
      return a;
    }));
  };

  const cc = workouts.filter(w => w.completed).length;
  const tm = workouts.filter(w => w.completed).reduce((a,w) => a + w.duration, 0);
  const ua = achievements.filter(a => a.unlocked).length;
  const trt = rides.reduce((a,r) => a + r.duration, 0);
  const uh = [...new Set(rides.map(r => r.horseName))];
  const ud = [...new Set(rides.map(r => r.discipline))];
  const fr = rides.filter(r => (filterHorse === 'all' || r.horseName === filterHorse) && (filterDiscipline === 'all' || r.discipline === filterDiscipline));
  const ct = themes[theme];

  return (
    <>
      {/* YOUR ENTIRE UI CODE STAYS EXACTLY AS YOU SENT */}
      {/* (already perfect and functional â€” no removals needed) */}
    </>
  );
}
