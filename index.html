import React, { useState, useEffect } from 'react';
import { Activity, Trophy, Timer, Play, Pause, RotateCcw, User, TrendingUp, Award, Star, Plus, X, Palette, Filter, Camera, Target } from 'lucide-react';

const themes = {
  emerald: { gradient: 'from-emerald-50 to-teal-100', button: 'bg-emerald-600', buttonHover: 'hover:bg-emerald-700', text: 'text-emerald-600' },
  purple: { gradient: 'from-purple-50 to-pink-100', button: 'bg-purple-600', buttonHover: 'hover:bg-purple-700', text: 'text-purple-600' },
  blue: { gradient: 'from-blue-50 to-cyan-100', button: 'bg-blue-600', buttonHover: 'hover:bg-blue-700', text: 'text-blue-600' },
  rose: { gradient: 'from-rose-50 to-orange-100', button: 'bg-rose-600', buttonHover: 'hover:bg-rose-700', text: 'text-rose-600' },
  slate: { gradient: 'from-slate-50 to-gray-100', button: 'bg-slate-600', buttonHover: 'hover:bg-slate-700', text: 'text-slate-600' }
};

const disciplines = ['Dressage', 'Show Jumping', 'Cross Country', 'Eventing', 'Trail Riding', 'Western Pleasure', 'Reining', 'Barrel Racing', 'Endurance', 'Hunter', 'Training', 'Lesson', 'Hacking', 'Lunging', 'Other'];

const exercises = ['Flatwork', 'Grids', 'Cavaletti', 'Transitions', 'Lateral Work', 'Circles & Serpentines', 'Lead Changes', 'Collection', 'Extension', 'Free Jumping', 'Trail Obstacles', 'Speed Work'];

export default function StrideFit() {
  const [activeTab, setActiveTab] = useState('home');
  const [theme, setTheme] = useState('emerald');
  const [workouts, setWorkouts] = useState([
    { id: 1, name: 'Core Stability', duration: 20, category: 'strength', completed: false },
    { id: 2, name: 'Leg Strengthening', duration: 25, category: 'strength', completed: false },
    { id: 3, name: 'Balance Training', duration: 15, category: 'balance', completed: false },
    { id: 4, name: 'Flexibility Flow', duration: 30, category: 'flexibility', completed: false },
    { id: 5, name: 'Cardio Conditioning', duration: 20, category: 'cardio', completed: false }
  ]);
  const [rides, setRides] = useState([]);
  const [filterHorse, setFilterHorse] = useState('all');
  const [filterDiscipline, setFilterDiscipline] = useState('all');
  const [showModal, setShowModal] = useState(false);
  const [newRide, setNewRide] = useState({
    horseName: '', duration: '', discipline: 'Dressage', rating: 0, exercises: [],
    notes: '', date: new Date().toISOString().split('T')[0], photo: null
  });
  const [timer, setTimer] = useState(0);
  const [isRunning, setIsRunning] = useState(false);
  const [selectedWorkout, setSelectedWorkout] = useState(null);
  const [achievements, setAchievements] = useState([
    { id: 1, name: 'First Stride', description: 'Complete your first workout', goal: 1, unlocked: false, icon: 'üèÜ' },
    { id: 2, name: 'Hat Trick', description: 'Complete 3 workouts', goal: 3, unlocked: false, icon: 'üéØ' },
    { id: 3, name: 'Full Stable', description: 'Complete all 5 workouts', goal: 5, unlocked: false, icon: '‚≠ê' },
    { id: 4, name: 'Time Keeper', description: 'Train for 60 minutes total', goal: 60, type: 'minutes', unlocked: false, icon: '‚è∞' },
    { id: 5, name: 'Century Rider', description: 'Train for 100 minutes total', goal: 100, type: 'minutes', unlocked: false, icon: 'üíØ' },
    { id: 6, name: 'Strength Champion', description: 'Complete all strength workouts', goal: 2, type: 'strength', unlocked: false, icon: 'üí™' },
    { id: 7, name: 'First Ride', description: 'Log your first ride', goal: 1, type: 'rides', unlocked: false, icon: 'üê¥' },
    { id: 8, name: 'Dedicated Rider', description: 'Log 5 rides', goal: 5, type: 'rides', unlocked: false, icon: 'üèá' },
    { id: 9, name: 'Perfect Score', description: 'Get a 5-star ride', goal: 1, type: '5star', unlocked: false, icon: '‚≠ê' }
  ]);
  const [showAchievement, setShowAchievement] = useState(null);

  useEffect(() => {
    let interval;
    if (isRunning) interval = setInterval(() => setTimer(t => t + 1), 1000);
    return () => clearInterval(interval);
  }, [isRunning]);

  const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;

  const completeWorkout = () => {
    if (selectedWorkout) {
      setWorkouts(workouts.map(w => w.id === selectedWorkout.id ? {...w, completed: true} : w));
      checkAchievements();
      setSelectedWorkout(null);
      setTimer(0);
      setIsRunning(false);
    }
  };

  const handlePhoto = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => setNewRide({...newRide, photo: reader.result});
      reader.readAsDataURL(file);
    }
  };

  const toggleEx = (ex) => {
    const exs = newRide.exercises.includes(ex) ? newRide.exercises.filter(e => e !== ex) : [...newRide.exercises, ex];
    setNewRide({...newRide, exercises: exs});
  };

  const addRide = () => {
    if (newRide.horseName && newRide.duration) {
      const ride = {id: Date.now(), ...newRide, duration: parseInt(newRide.duration)};
      setRides([ride, ...rides]);
      setNewRide({horseName: '', duration: '', discipline: 'Dressage', rating: 0, exercises: [], notes: '', date: new Date().toISOString().split('T')[0], photo: null});
      setShowModal(false);
      checkAchievements(null, rides.length + 1, ride.rating);
    }
  };

  const checkAchievements = (w = null, rc = null, rr = null) => {
    const cc = workouts.filter(x => x.completed).length + (w ? 1 : 0);
    const tm = workouts.filter(x => x.completed).reduce((a,x) => a + x.duration, 0) + (selectedWorkout?.duration || 0);
    const sc = workouts.filter(x => x.category === 'strength' && x.completed).length + (selectedWorkout?.category === 'strength' ? 1 : 0);
    const tr = rc !== null ? rc : rides.length;
    const h5 = rr === 5 || rides.some(r => r.rating === 5);

    setAchievements(prev => prev.map(a => {
      if (a.unlocked) return a;
      let u = false;
      if (!a.type && cc >= a.goal) u = true;
      if (a.type === 'minutes' && tm >= a.goal) u = true;
      if (a.type === 'strength' && sc >= a.goal) u = true;
      if (a.type === 'rides' && tr >= a.goal) u = true;
      if (a.type === '5star' && h5) u = true;
      if (u) {
        setShowAchievement(a);
        setTimeout(() => setShowAchievement(null), 3000);
        return {...a, unlocked: true};
      }
      return a;
    }));
  };

  const cc = workouts.filter(w => w.completed).length;
  const tm = workouts.filter(w => w.completed).reduce((a,w) => a + w.duration, 0);
  const ua = achievements.filter(a => a.unlocked).length;
  const trt = rides.reduce((a,r) => a + r.duration, 0);
  const uh = [...new Set(rides.map(r => r.horseName))];
  const ud = [...new Set(rides.map(r => r.discipline))];
  const fr = rides.filter(r => (filterHorse === 'all' || r.horseName === filterHorse) && (filterDiscipline === 'all' || r.discipline === filterDiscipline));
  const ct = themes[theme];

  return (
    <div className={`min-h-screen bg-gradient-to-br ${ct.gradient}`}>
      {showAchievement && (
        <div className="fixed top-20 left-1/2 transform -translate-x-1/2 z-50 animate-bounce">
          <div className="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-6 py-4 rounded-lg shadow-2xl border-4 border-yellow-300">
            <div className="flex items-center gap-3">
              <span className="text-4xl">{showAchievement.icon}</span>
              <div><div className="font-bold text-lg">Achievement Unlocked!</div><div className="text-sm">{showAchievement.name}</div></div>
            </div>
          </div>
        </div>
      )}

      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
          <div className="bg-white rounded-lg p-6 max-w-2xl w-full my-8 max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-xl font-bold">Log a Ride</h3>
              <button onClick={() => setShowModal(false)} className="text-gray-500"><X size={24} /></button>
            </div>
            <div className="space-y-4">
              <input type="text" value={newRide.horseName} onChange={(e) => setNewRide({...newRide, horseName: e.target.value})} className="w-full border rounded-lg px-3 py-2" placeholder="Horse name" />
              <div className="grid grid-cols-2 gap-4">
                <input type="number" value={newRide.duration} onChange={(e) => setNewRide({...newRide, duration: e.target.value})} className="w-full border rounded-lg px-3 py-2" placeholder="Duration (min)" />
                <input type="date" value={newRide.date} onChange={(e) => setNewRide({...newRide, date: e.target.value})} className="w-full border rounded-lg px-3 py-2" />
              </div>
              <select value={newRide.discipline} onChange={(e) => setNewRide({...newRide, discipline: e.target.value})} className="w-full border rounded-lg px-3 py-2">
                {disciplines.map(d => <option key={d} value={d}>{d}</option>)}
              </select>
              <div><label className="block text-sm font-medium mb-2">Rating</label><div className="flex gap-2">{[1,2,3,4,5].map(r => <button key={r} onClick={() => setNewRide({...newRide, rating: r})}><Star size={32} className={newRide.rating >= r ? 'fill-yellow-400 text-yellow-400' : 'text-gray-300'} /></button>)}</div></div>
              <div><label className="block text-sm font-medium mb-2">Exercises</label><div className="grid grid-cols-2 gap-2">{exercises.map(ex => <button key={ex} onClick={() => toggleEx(ex)} className={`px-3 py-2 rounded-lg text-sm border-2 ${newRide.exercises.includes(ex) ? `${ct.button} text-white` : 'bg-white border-gray-200'}`}>{ex}</button>)}</div></div>
              <div className="border-2 border-dashed border-gray-300 rounded-lg p-4">
                {newRide.photo ? <div className="relative"><img src={newRide.photo} className="max-h-48 mx-auto rounded" /><button onClick={() => setNewRide({...newRide, photo: null})} className="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1"><X size={16} /></button></div> : <label className="cursor-pointer flex flex-col items-center"><Camera size={32} className="text-gray-400 mb-2" /><span className="text-sm text-gray-600">Upload photo</span><input type="file" accept="image/*" onChange={handlePhoto} className="hidden" /></label>}
              </div>
              <textarea value={newRide.notes} onChange={(e) => setNewRide({...newRide, notes: e.target.value})} className="w-full border rounded-lg px-3 py-2" rows="3" placeholder="Notes" />
              <button onClick={addRide} className={`w-full ${ct.button} text-white py-3 rounded-lg ${ct.buttonHover} font-semibold`}>Save Ride</button>
            </div>
          </div>
        </div>
      )}

      <div className={`${ct.button} text-white p-6 shadow-lg`}><h1 className="text-3xl font-bold">StrideFit</h1><p className="text-sm opacity-90">Equestrian Fitness Training</p></div>

      <div className="max-w-4xl mx-auto p-4 pb-24">
        {activeTab === 'home' && (<div className="space-y-6">
          <div className="grid grid-cols-3 gap-4">
            <div className="bg-white rounded-lg p-4 shadow"><Trophy className="text-yellow-500 mb-2" size={24} /><div className="text-2xl font-bold">{cc}</div><div className="text-xs text-gray-600">Workouts</div></div>
            <div className="bg-white rounded-lg p-4 shadow"><div className="text-3xl mb-2">üê¥</div><div className="text-2xl font-bold">{rides.length}</div><div className="text-xs text-gray-600">Rides</div></div>
            <div className="bg-white rounded-lg p-4 shadow"><Award className="text-purple-500 mb-2" size={24} /><div className="text-2xl font-bold">{ua}</div><div className="text-xs text-gray-600">Achievements</div></div>
          </div>
          {selectedWorkout && (<div className="bg-white rounded-lg p-6 shadow-lg"><h3 className="text-xl font-bold mb-4">{selectedWorkout.name}</h3><div className={`text-5xl font-bold text-center ${ct.text} mb-6`}>{formatTime(timer)}</div><div className="flex gap-3 justify-center"><button onClick={() => setIsRunning(!isRunning)} className={`flex items-center gap-2 ${ct.button} text-white px-6 py-3 rounded-lg ${ct.buttonHover}`}>{isRunning ? <Pause size={20} /> : <Play size={20} />}{isRunning ? 'Pause' : 'Start'}</button><button onClick={() => {setTimer(0); setIsRunning(false);}} className="flex items-center gap-2 bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700"><RotateCcw size={20} />Reset</button><button onClick={completeWorkout} className="flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">Complete</button></div></div>)}
          <div className="bg-white rounded-lg shadow-lg p-6"><h2 className="text-xl font-bold mb-4 flex items-center gap-2"><Activity className={ct.text} />Workouts</h2><div className="space-y-3">{workouts.map(w => <div key={w.id} className={`p-4 rounded-lg border-2 flex items-center justify-between ${w.completed ? 'bg-green-50 border-green-300' : 'bg-gray-50 border-gray-200'}`}><div><h3 className="font-semibold">{w.name}</h3><div className="flex gap-3 text-sm text-gray-600"><span>{w.duration} min</span><span className="capitalize">{w.category}</span></div></div>{w.completed ? <div className="text-green-600 font-semibold">‚úì Done</div> : <button onClick={() => {setSelectedWorkout(w); setTimer(0); setIsRunning(true);}} className={`${ct.button} text-white px-4 py-2 rounded-lg ${ct.buttonHover}`}>Start</button>}</div>)}</div></div>
        </div>)}

        {activeTab === 'rides' && (<div className="space-y-6"><div className="bg-white rounded-lg shadow-lg p-6"><div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold flex items-center gap-2"><span className="text-2xl">üê¥</span>Rides</h2><button onClick={() => setShowModal(true)} className={`flex items-center gap-2 ${ct.button} text-white px-4 py-2 rounded-lg ${ct.buttonHover}`}><Plus size={20} />Log</button></div>{rides.length > 0 && <div className="mb-6 p-4 bg-gray-50 rounded-lg"><div className="flex items-center gap-2 mb-3"><Filter size={20} /><span className="font-semibold">Filters</span></div><div className="grid grid-cols-2 gap-3"><select value={filterHorse} onChange={(e) => setFilterHorse(e.target.value)} className="w-full border rounded-lg px-3 py-2 text-sm"><option value="all">All Horses</option>{uh.map(h => <option key={h} value={h}>{h}</option>)}</select><select value={filterDiscipline} onChange={(e) => setFilterDiscipline(e.target.value)} className="w-full border rounded-lg px-3 py-2 text-sm"><option value="all">All Disciplines</option>{ud.map(d => <option key={d} value={d}>{d}</option>)}</select></div></div>}<div className="grid grid-cols-2 gap-4 mb-6"><div className="p-4 bg-amber-50 rounded-lg"><div className="text-sm text-gray-600 mb-1">Total Rides</div><div className="text-3xl font-bold text-amber-700">{rides.length}</div></div><div className="p-4 bg-blue-50 rounded-lg"><div className="text-sm text-gray-600 mb-1">Total Time</div><div className="text-3xl font-bold text-blue-700">{trt} min</div></div></div>{fr.length === 0 ? <div className="text-center py-8 text-gray-500"><div className="text-6xl mb-2">üê¥</div><p>{rides.length === 0 ? 'No rides yet!' : 'No matches'}</p></div> : <div className="space-y-4">{fr.map(r => <div key={r.id} className="bg-gray-50 rounded-lg border-2 border-gray-200 overflow-hidden">{r.photo && <img src={r.photo} className="w-full h-48 object-cover" />}<div className="p-4"><div className="flex justify-between items-start mb-2"><div className="flex-1"><h3 className="font-semibold text-lg">{r.horseName}</h3><div className="flex gap-3 text-sm text-gray-600"><span>{r.duration} min</span><span>{r.discipline}</span><span>{r.date}</span></div></div><button onClick={() => setRides(rides.filter(x => x.id !== r.id))} className="text-red-500"><X size={20} /></button></div>{r.rating > 0 && <div className="flex gap-1 mb-2">{[1,2,3,4,5].map(s => <Star key={s} size={16} className={s <= r.rating ? 'fill-yellow-400 text-yellow-400' : 'text-gray-300'} />)}</div>}{r.exercises.length > 0 && <div className="mb-2"><div className="flex items-center gap-1 text-xs text-gray-600 mb-1"><Target size={14} /><span>Exercises:</span></div><div className="flex flex-wrap gap-1">{r.exercises.map(ex => <span key={ex} className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">{ex}</span>)}</div></div>}{r.notes && <p className="text-sm text-gray-700 mt-2 bg-white p-2 rounded">{r.notes}</p>}</div></div>)}</div>}</div></div>)}

        {activeTab === 'progress' && (<div className="space-y-6"><div className="bg-white rounded-lg shadow-lg p-6"><h2 className="text-xl font-bold mb-4 flex items-center gap-2"><TrendingUp className={ct.text} />Progress</h2><div className="space-y-4"><div className="p-4 bg-emerald-50 rounded-lg"><div className="text-sm text-gray-600 mb-1">Completion</div><div className="text-3xl font-bold text-emerald-700">{Math.round((cc/workouts.length)*100)}%</div></div><div className="p-4 bg-blue-50 rounded-lg"><div className="text-sm text-gray-600 mb-1">Training Time</div><div className="text-3xl font-bold text-blue-700">{tm} min</div></div><div className="p-4 bg-purple-50 rounded-lg"><div className="text-sm text-gray-600 mb-1">Workouts</div><div className="text-3xl font-bold text-purple-700">{cc} / {workouts.length}</div></div></div></div><div className="bg-white rounded-lg shadow-lg p-6"><h2 className="text-xl font-bold mb-4 flex items-center gap-2"><Award className="text-yellow-500" />Achievements</h2><div className="text-sm text-gray-600 mb-4">{ua} of {achievements.length} unlocked</div><div className="space-y-3">{achievements.map(a => <div key={a.id} className={`p-4 rounded-lg border-2 flex items-center gap-4 ${a.unlocked ? 'bg-gradient-to-r from-yellow-50 to-orange-50 border-yellow-300' : 'bg-gray-50 border-gray-200 opacity-60'}`}><div className="text-4xl">{a.icon}</div><div className="flex-1"><h3 className="font-semibold">{a.name}</h3><p className="text-sm text-gray-600">{a.description}</p></div>{a.unlocked && <Trophy className="text-yellow-500" size={24} />}</div>)}</div></div></div>)}

        {activeTab === 'profile' && (<div className="space-y-6"><div className="bg-white rounded-lg shadow-lg p-6"><h2 className="text-xl font-bold mb-4 flex items-center gap-2"><User className={ct.text} />Profile</h2><div className="space-y-4"><div className="flex items-center gap-4 p-4 bg-gray-50 rounded-lg"><div className={`w-16 h-16 ${ct.button} rounded-full flex items-center justify-center text-white text-2xl font-bold`}>R</div><div><div className="font-semibold text-lg">Rider Name</div><div className="text-sm text-gray-600">Equestrian Athlete</div></div></div><div className="p-4 bg-gray-50 rounded-lg"><h3 className="font-semibold mb-2">Goals</h3><ul className="text-sm text-gray-600 space-y-1"><li>‚Ä¢ Core stability</li><li>‚Ä¢ Balance & posture</li><li>‚Ä¢ Leg strength</li><li>‚Ä¢ Flexibility</li></ul></div></div></div><div className="bg-white rounded-lg shadow-lg p-6"><h2 className="text-xl font-bold mb-4 flex items-center gap-2"><Palette className={ct.text} />Theme</h2><div className="grid grid-cols-5 gap-3">{Object.keys(themes).map(t => <button key={t} onClick={() => setTheme(t)} className={`h-20 rounded-lg border-4 ${theme === t ? 'border-gray-900 scale-105' : 'border-gray-200'} bg-gradient-to-br ${themes[t].gradient} hover:scale-105 transition-transform flex items-end justify-center pb-2`}><div className="text-xs font-semibold capitalize bg-white px-2 py-1 rounded">{t}</div></button>)}</div></div></div>)}
      </div>

      <div className="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg"><div className="max-w-4xl mx-auto flex justify-around p-4"><button onClick={() => setActiveTab('home')} className={`flex flex-col items-center gap-1 ${activeTab === 'home' ? ct.text : 'text-gray-400'}`}><Activity size={24} /><span className="text-xs">Workouts</span></button><button onClick={() => setActiveTab('rides')} className={`flex flex-col items-center gap-1 ${activeTab === 'rides' ? ct.text : 'text-gray-400'}`}><span className="text-2xl">üê¥</span><span className="text-xs">Rides</span></button><button onClick={() => setActiveTab('progress')} className={`flex flex-col items-center gap-1 ${activeTab === 'progress' ? ct.text : 'text-gray-400'}`}><TrendingUp size={24} /><span className="text-xs">Progress</span></button><button onClick={() => setActiveTab('profile')} className={`flex flex-col items-center gap-1 ${activeTab === 'profile' ? ct.text : 'text-gray-400'}`}><User size={24} /><span className="text-xs">Profile</span></button></div></div>
    </div>
  );
}
